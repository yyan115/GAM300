name: Build GAM300 Engine

on:
  push:
    branches: [ main, cmake-port-m3 ]
  pull_request:
    branches: [ main ]

env:
  # vcpkg commit - update this when you want to upgrade vcpkg
  VCPKG_COMMIT: 2d6a6cf3ac9a7cc93942c3d289a2f9c661a6f4a7

jobs:
  # Setup vcpkg once, share cache with all build jobs
  setup-vcpkg:
    runs-on: windows-2022
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Cache vcpkg
      id: cache-vcpkg
      uses: actions/cache@v4
      with:
        path: vcpkg
        key: vcpkg-exe-${{ env.VCPKG_COMMIT }}

    - name: Cache vcpkg packages
      id: cache-vcpkg-packages
      uses: actions/cache@v4
      with:
        path: Project/Build/vcpkg_installed
        key: vcpkg-pkgs-${{ env.VCPKG_COMMIT }}-${{ hashFiles('Project/vcpkg.json') }}

    - name: Bootstrap vcpkg
      if: steps.cache-vcpkg.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        cd vcpkg
        git checkout ${{ env.VCPKG_COMMIT }}
        .\bootstrap-vcpkg.bat -disableMetrics
      shell: pwsh

    - name: Install dependencies
      if: steps.cache-vcpkg-packages.outputs.cache-hit != 'true'
      run: cmake --preset debug
      working-directory: Project

  build:
    needs: setup-vcpkg
    runs-on: windows-2022

    strategy:
      fail-fast: false
      matrix:
        preset: [debug, release, editor-debug, editor-release]
        include:
          - preset: debug
            output_dir: Debug
          - preset: release
            output_dir: Release
          - preset: editor-debug
            output_dir: EditorDebug
          - preset: editor-release
            output_dir: EditorRelease

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Restore vcpkg cache
      uses: actions/cache/restore@v4
      with:
        path: vcpkg
        key: vcpkg-exe-${{ env.VCPKG_COMMIT }}

    - name: Restore vcpkg packages cache
      uses: actions/cache/restore@v4
      with:
        path: Project/Build/vcpkg_installed
        key: vcpkg-pkgs-${{ env.VCPKG_COMMIT }}-${{ hashFiles('Project/vcpkg.json') }}

    - name: Configure CMake
      run: cmake --preset ${{ matrix.preset }}
      working-directory: Project

    # Enable MSVC error annotations on PRs (file:line links in the diff)
    - name: Setup MSVC problem matcher
      run: |
        echo '::add-matcher::${{ github.workspace }}/.github/matchers/msvc.json'

    - name: Build
      id: build
      run: |
        cmake --build --preset ${{ matrix.preset }} --parallel 2>&1 | Tee-Object -FilePath build.log
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
      working-directory: Project
      shell: pwsh

    - name: Extract errors
      if: always()
      run: |
        echo "${{ steps.build.outcome }}" > Project/build-result.txt
        # Extract MSVC error and fatal error lines (file(line): error Cxxxx: message)
        grep -E ": (fatal )?error [A-Z][0-9]+:" Project/build.log > Project/build-errors.txt 2>/dev/null || true
        # Also grab linker errors (LINK : fatal error LNKxxxx)
        grep -Ei "^LINK : " Project/build.log >> Project/build-errors.txt 2>/dev/null || true
        # Deduplicate
        sort -u Project/build-errors.txt -o Project/build-errors.txt 2>/dev/null || true
      shell: bash

    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ matrix.preset }}
        path: |
          Project/build.log
          Project/build-result.txt
          Project/build-errors.txt
        retention-days: 7
        if-no-files-found: ignore

    # Upload executable and required DLLs
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Build-${{ matrix.preset }}
        path: |
          Project/Build/${{ matrix.output_dir }}/*.exe
          Project/Build/${{ matrix.output_dir }}/*.dll
          Project/Build/${{ matrix.output_dir }}/Resources/**
        retention-days: 7
        if-no-files-found: error

  # Build Engine + Game for Android (arm64) to catch cross-platform breakages
  android-build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Cache Jolt Physics (FetchContent)
      uses: actions/cache@v4
      with:
        path: Project/Build/android-ci/_deps
        key: android-deps-${{ hashFiles('Project/ImportDependencies.cmake') }}

    - name: Install NDK and Ninja
      run: |
        echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;29.0.14033849"
        sudo apt-get update && sudo apt-get install -y ninja-build

    # Enable GCC/Clang error annotations on PRs
    - name: Setup GCC problem matcher
      run: |
        echo '::add-matcher::${{ github.workspace }}/.github/matchers/gcc.json'

    - name: Configure CMake for Android
      run: |
        cmake -S Project -B Project/Build/android-ci \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_HOME/ndk/29.0.14033849/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-33 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_ANDROID_STL_TYPE=c++_shared

    - name: Build
      id: android-build
      run: |
        cmake --build Project/Build/android-ci --parallel 2>&1 | tee build-android.log
        if [ ${PIPESTATUS[0]} -ne 0 ]; then exit 1; fi

    - name: Extract errors
      if: always()
      run: |
        echo "${{ steps.android-build.outcome }}" > build-result.txt
        # Extract GCC/Clang error lines (file:line:col: error: message)
        grep -E ": error:" build-android.log > build-errors.txt 2>/dev/null || true
        # Also grab linker errors
        grep -Ei "undefined reference to|ld: error:" build-android.log >> build-errors.txt 2>/dev/null || true
        # Deduplicate
        sort -u build-errors.txt -o build-errors.txt 2>/dev/null || true

    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-android
        path: |
          build-android.log
          build-result.txt
          build-errors.txt
        retention-days: 7
        if-no-files-found: ignore

  # Lint: block new std::cout in Engine code
  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check for banned patterns in new code
      run: |
        # Determine diff base
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE="${{ github.event.pull_request.base.sha }}"
        else
          BASE="HEAD~1"
        fi

        DIRS="Project/Engine/src/ Project/Engine/include/ Project/Scripting/src/ Project/Scripting/include/ Project/Game/src/ Project/Game/include/"

        # Get only added lines (+) in Engine/Game/Scripting source files
        DIFF=$(git diff "$BASE"...HEAD -- \
          'Project/Engine/src/**' 'Project/Engine/include/**' \
          'Project/Scripting/src/**' 'Project/Scripting/include/**' \
          'Project/Game/src/**' 'Project/Game/include/**' \
          | grep '^+' | grep -v '^+++' || true)

        FAILED=false
        REPORT=""

        # Check: std::cout / std::cerr
        COUT_HITS=$(echo "$DIFF" | grep 'std::cout\|std::cerr' || true)
        if [ -n "$COUT_HITS" ]; then
          FAILED=true
          REPORT="${REPORT}
        ### std::cout / std::cerr
        Use \`ENGINE_PRINT(...)\` or \`ENGINE_LOG_INFO(msg)\` instead.
        \`\`\`
        ${COUT_HITS}
        \`\`\`
        "
        fi

        # Check: #include <iostream>
        IOSTREAM_HITS=$(echo "$DIFF" | grep '#include.*<iostream>' || true)
        if [ -n "$IOSTREAM_HITS" ]; then
          FAILED=true
          REPORT="${REPORT}
        ### #include <iostream>
        Not needed if using ENGINE_PRINT / ENGINE_LOG. Remove it.
        \`\`\`
        ${IOSTREAM_HITS}
        \`\`\`
        "
        fi

        # Check: std::ifstream / std::ofstream without platform guard (breaks Android)
        FSTREAM_HITS=$(echo "$DIFF" | grep 'std::ifstream\|std::ofstream' || true)
        if [ -n "$FSTREAM_HITS" ]; then
          REPORT="${REPORT}
        ### std::ifstream / std::ofstream (warning)
        These break on Android. Use \`platform->ReadAsset()\` or guard with \`#ifdef ANDROID\`.
        \`\`\`
        ${FSTREAM_HITS}
        \`\`\`
        "
        fi

        # Check: #include <filesystem> (breaks Android NDK)
        FILESYSTEM_HITS=$(echo "$DIFF" | grep '#include.*<filesystem>' || true)
        if [ -n "$FILESYSTEM_HITS" ]; then
          REPORT="${REPORT}
        ### #include \<filesystem\> (warning)
        Not available on Android NDK. Guard with \`#ifndef ANDROID\` or use platform file utilities.
        \`\`\`
        ${FILESYSTEM_HITS}
        \`\`\`
        "
        fi

        # Summary
        echo "## Lint" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "$FAILED" = true ]; then
          echo "Banned patterns found in new Engine/Game/Scripting code:" >> $GITHUB_STEP_SUMMARY
          echo "$REPORT" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "FAILED: Banned patterns in new code"
          echo "$REPORT"
          exit 1
        else
          echo "No banned patterns in new code." >> $GITHUB_STEP_SUMMARY
        fi

        # Info: total existing tech debt
        TOTAL=$(grep -r 'std::cout\|std::cerr' \
          $DIRS \
          --include='*.cpp' --include='*.hpp' --include='*.h' \
          -c 2>/dev/null | awk -F: '{s+=$2} END {print s+0}')
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Tech debt: $TOTAL existing std::cout/cerr in Engine — clean up over time.*" >> $GITHUB_STEP_SUMMARY

  # Aggregate summary with inline error details
  build-summary:
    needs: [build, android-build, lint]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all build logs
        uses: actions/download-artifact@v4
        with:
          pattern: build-log-*
          path: logs/

      - name: Build Results Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | Status | Errors |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY

          HAS_FAILURES=false

          for config in debug release editor-debug editor-release android; do
            dir="logs/build-log-$config"
            result_file="$dir/build-result.txt"
            errors_file="$dir/build-errors.txt"

            case $config in
              debug)          display="Debug" ;;
              release)        display="Release" ;;
              editor-debug)   display="Editor Debug" ;;
              editor-release) display="Editor Release" ;;
              android)        display="Android (arm64)" ;;
            esac

            if [ ! -f "$result_file" ]; then
              echo "| $display | SKIP | — |" >> $GITHUB_STEP_SUMMARY
              continue
            fi

            result=$(cat "$result_file" | tr -d '[:space:]')
            if [ "$result" = "success" ]; then
              echo "| $display | PASS | 0 |" >> $GITHUB_STEP_SUMMARY
            else
              error_count=0
              if [ -f "$errors_file" ] && [ -s "$errors_file" ]; then
                error_count=$(wc -l < "$errors_file")
              fi
              echo "| $display | **FAIL** | $error_count |" >> $GITHUB_STEP_SUMMARY
              HAS_FAILURES=true
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          # Show error details for failed builds
          # Lint result
          if [ "${{ needs.lint.result }}" = "success" ]; then
            echo "| Lint | PASS | 0 |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.lint.result }}" = "failure" ]; then
            echo "| Lint | **FAIL** | see below |" >> $GITHUB_STEP_SUMMARY
            HAS_FAILURES=true
          else
            echo "| Lint | SKIP | — |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$HAS_FAILURES" = true ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            for config in debug release editor-debug editor-release android; do
              dir="logs/build-log-$config"
              result_file="$dir/build-result.txt"
              errors_file="$dir/build-errors.txt"

              [ -f "$result_file" ] || continue
              result=$(cat "$result_file" | tr -d '[:space:]')
              [ "$result" != "success" ] || continue

              case $config in
                debug)          display="Debug" ;;
                release)        display="Release" ;;
                editor-debug)   display="Editor Debug" ;;
                editor-release) display="Editor Release" ;;
                android)        display="Android (arm64)" ;;
              esac

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### $display" >> $GITHUB_STEP_SUMMARY

              if [ -f "$errors_file" ] && [ -s "$errors_file" ]; then
                echo '```' >> $GITHUB_STEP_SUMMARY
                cat "$errors_file" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
              else
                # No parsed errors — show tail of full log as fallback
                log_file=$(find "$dir" -name "*.log" 2>/dev/null | head -1)
                if [ -f "$log_file" ]; then
                  echo "Could not extract specific errors. Last 30 lines of build log:" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  tail -30 "$log_file" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                fi
              fi

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "*Full log available in build-log-$config artifact.*" >> $GITHUB_STEP_SUMMARY
            done
            exit 1
          else
            echo "All builds passed." >> $GITHUB_STEP_SUMMARY
          fi
